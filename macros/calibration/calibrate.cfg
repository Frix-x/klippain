[gcode_macro CALIBRATE]
description: Calibrate the printer flow or pressure advance
gcode:
    # Type of calibration
    {% set TYPE = params.TYPE|default("")|string|lower %}
    {% set BED_TEMP = params.BED_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_bed_temp)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(printer["gcode_macro _USER_VARIABLES"].print_default_extruder_temp)|float %}
    {% set MATERIAL = params.MATERIAL|default(printer["gcode_macro _USER_VARIABLES"].print_default_material)|string %}
    {% set CONTROL_SPEED = params.CONTROL_SPEED|default(80)|string %}
    {% set TRAVEL_SPEED = params.TRAVEL_SPEED|default(100)|string %}
	{% set DO_RAFT = params.DO_RAFT|default(1)|string %}
    {% set RAFT_SPEED = params.RAFT_SPEED|default(80)|string %}
    
    {% if TYPE=="flow" %}
        # Call the standard START_PRINT with almost no soaking time and no chamber temp requirement (we want to go fast!)
        # Also no bed mesh needed for this one as it's a small center print
        START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE=130_130_170_170
        FLOW_MULTIPLIER_CALIBRATION DO_RAFT={DO_RAFT} EXTRUSION_WIDTH=0.40 CONTROL_SPEED={CONTROL_SPEED} TRAVEL_SPEED={TRAVEL_SPEED} RAFT_SPEED={RAFT_SPEED}
        END_PRINT FILTER_TIME=0
    
    {% elif TYPE=="pressure_advance" %}
        # Call the standard START_PRINT with almost no soaking time and no chamber temp requirement (we want to go fast!)
        # A bed mesh is needed for this one as it's a large print (120mm sized square)
        START_PRINT EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} MATERIAL={MATERIAL} SOAK=1 SIZE=90_90_210_210
        PRESSURE_ADVANCE_CALIBRATION DO_RAFT={DO_RAFT} CONTROL_SPEED={CONTROL_SPEED} TRAVEL_SPEED={TRAVEL_SPEED} RAFT_SPEED={RAFT_SPEED}
        END_PRINT FILTER_TIME=0

    {% else %}
        {action_respond_info("Please call this macro using TYPE= \"flow\" or \"pressure_advance\"")}
        {action_raise_error("not enough parameters to start a calibration!")}
    
    {% endif %}
