[gcode_macro _KNOMI_STATUS]
variable_homing: False
variable_probing: False
variable_qgling: False
variable_heating_nozzle: False
variable_heating_bed: False
variable_heaters_delayed_workaround: False
gcode:



[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: SET_HEATER_TEMPERATURE_BASE
gcode:
  {% set HEATER = params.HEATER|string %} 
  {% set TARGET = params.TARGET|int %} 
  
  {% if HEATER == 'extruder' %}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE={False if TARGET == 0 else True}
  {% endif %}
  {% if HEATER == 'heater_bed' %}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE={False if TARGET == 0 else True}
  {% endif %}

  {% if printer["gcode_macro _KNOMI_STATUS"].heaters_delayed_workaround == False or TARGET == 0 %}
    {% set delay = printer["gcode_macro _USER_VARIABLES"].knomi_heaters_wait_delay|default(30) %}
    UPDATE_DELAYED_GCODE ID=_KNOMI_HEATERS_AUTO_OFF DURATION={0 if TARGET == 0 else delay}
  {% endif %}                                                                                       
  
  SET_HEATER_TEMPERATURE_BASE {rawparams}


[delayed_gcode _KNOMI_HEATERS_AUTO_OFF]
initial_duration: 0
gcode:
  {% set mustWait = False %}
  
  {% set temp = printer.heater_bed.temperature %}
  {% set target = printer.heater_bed.target %}

  {% if printer["gcode_macro _KNOMI_STATUS"].heating_bed and temp < target %}
    {% set mustWait = True %}
  {% else %}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=False
  {% endif %}

  {% set temp = printer.extruder.temperature %}
  {% set target = printer.extruder.target %}

  {% if printer["gcode_macro _KNOMI_STATUS"].heating_nozzle and temp < target %}
    {% set mustWait = True %}
  {% else %}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=False
  {% endif %}

  {% if mustWait %}
    {% set delay = printer["gcode_macro _USER_VARIABLES"].knomi_heaters_wait_delay|default(30) %}
    UPDATE_DELAYED_GCODE ID=_KNOMI_HEATERS_AUTO_OFF DURATION={delay}
  {% else %}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heaters_delayed_workaround VALUE=False
  {% endif %}
  