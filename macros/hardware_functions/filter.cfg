[gcode_macro START_FILTER]
gcode:
    {% set SPEED = params.SPEED|default(1)|float %}

    {% set filter_name = printer["gcode_macro _USER_VARIABLES"].filter_name %}
    SET_FAN_SPEED FAN={filter_name} SPEED={SPEED}


[gcode_macro STOP_FILTER]
gcode:
    {% set filter_name = printer["gcode_macro _USER_VARIABLES"].filter_name %}
    {% set is_nevermore_controller = printer["gcode_macro _USER_VARIABLES"].filter_nevermore_contoller %}
    {% if is_nevermore_controller %}
	SET_FAN_SPEED FAN={filter_name}
    {% else %}
    	SET_FAN_SPEED FAN={filter_name} SPEED=0
    {% endif %}


[delayed_gcode _STOP_FILTER_DELAYED]
gcode:
    STOP_FILTER
